<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Depurador de Exclusão de Disciplinas</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1, h2, h3 {
            color: #333;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 10px 5px;
            cursor: pointer;
            border-radius: 4px;
        }
        button.delete {
            background-color: #f44336;
        }
        button.debug {
            background-color: #2196F3;
        }
        button.orphan {
            background-color: #FF9800;
        }
        .panel {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }
        #disciplineList {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }
        .discipline-card {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            background-color: #fff;
        }
        .discipline-card h3 {
            margin-top: 0;
            color: #333;
        }
        .log-entry {
            padding: 5px;
            margin: 2px 0;
            border-radius: 3px;
        }
        .log-entry.info {
            background-color: #e8f4fd;
        }
        .log-entry.success {
            background-color: #e6f8e6;
        }
        .log-entry.warning {
            background-color: #fff8e8;
        }
        .log-entry.error {
            background-color: #ffe8e8;
        }
        #logs {
            height: 300px;
            overflow-y: auto;
            background-color: #f8f8f8;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 20px;
        }
        .error {
            color: #f44336;
        }
        .success {
            color: #4CAF50;
        }
        .warning {
            color: #FF9800;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Depurador de Exclusão de Disciplinas</h1>
        
        <div class="panel">
            <h2>Status de Autenticação</h2>
            <div id="auth-status">
                <p class="warning">Verificando autenticação...</p>
            </div>
            
            <div id="login-form" style="display: none;">
                <h3>Login</h3>
                <div style="margin-bottom: 10px;">
                    <label for="email">Email:</label>
                    <input type="email" id="email" style="padding: 5px; width: 250px;">
                </div>
                <div style="margin-bottom: 10px;">
                    <label for="password">Senha:</label>
                    <input type="password" id="password" style="padding: 5px; width: 250px;">
                </div>
                <button id="login-btn">Login</button>
            </div>
        </div>
        
        <div class="panel">
            <h2>Disciplinas</h2>
            <div>
                <button id="loadDisciplines">Carregar Disciplinas</button>
                <button id="checkOrphans" class="orphan">Verificar Registros Órfãos</button>
            </div>
            <div id="disciplineList">
                <p>Clique em "Carregar Disciplinas" para ver a lista.</p>
            </div>
        </div>
        
        <div class="panel">
            <h2>Logs</h2>
            <button id="clearLogs">Limpar Logs</button>
            <div id="logs"></div>
        </div>
    </div>
    
    <script>
        // Inicializar Supabase client
        const SUPABASE_URL = "https://vcqmpvfgepruwgxzfjzu.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZjcW1wdmZnZXBydXdneHpmanp1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY3NTc5MDgsImV4cCI6MjA2MjMzMzkwOH0.avZUr0--1hm-jrvApfy5LDsZhUgjGIpYaiSEGhuir-g";
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // Elementos DOM
        const authStatusDiv = document.getElementById('auth-status');
        const loginForm = document.getElementById('login-form');
        const disciplineListDiv = document.getElementById('disciplineList');
        const logsDiv = document.getElementById('logs');
        
        // Log function para mostrar mensagens de debug
        function log(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logsDiv.appendChild(entry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }
        
        // Limpar logs
        document.getElementById('clearLogs').addEventListener('click', () => {
            logsDiv.innerHTML = '';
        });
        
        // Verificar autenticação
        async function checkAuth() {
            try {
                const { data, error } = await supabase.auth.getSession();
                
                if (error) {
                    authStatusDiv.innerHTML = `<p class="error">Erro ao verificar autenticação: ${error.message}</p>`;
                    log(`Erro ao verificar autenticação: ${error.message}`, 'error');
                    return null;
                }
                
                if (data.session && data.session.user) {
                    authStatusDiv.innerHTML = `
                        <p class="success">
                            <strong>Autenticado como:</strong> ${data.session.user.email}<br>
                            <strong>ID:</strong> ${data.session.user.id}<br>
                            <button id="logout-btn">Sair</button>
                        </p>
                    `;
                    document.getElementById('logout-btn').addEventListener('click', logout);
                    loginForm.style.display = 'none';
                    log(`Autenticado como: ${data.session.user.email}`, 'success');
                    return data.session.user;
                } else {
                    authStatusDiv.innerHTML = `<p class="warning">Não autenticado. Faça login para testar exclusões.</p>`;
                    loginForm.style.display = 'block';
                    log('Não autenticado', 'warning');
                    return null;
                }
            } catch (err) {
                authStatusDiv.innerHTML = `<p class="error">Erro: ${err.message}</p>`;
                log(`Erro: ${err.message}`, 'error');
                return null;
            }
        }
        
        // Logout
        async function logout() {
            try {
                const { error } = await supabase.auth.signOut();
                if (error) {
                    log(`Erro ao fazer logout: ${error.message}`, 'error');
                    return;
                }
                
                log('Logout realizado com sucesso', 'success');
                checkAuth();
            } catch (err) {
                log(`Erro ao fazer logout: ${err.message}`, 'error');
            }
        }
        
        // Login
        document.getElementById('login-btn').addEventListener('click', async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                log('Email e senha são obrigatórios', 'error');
                return;
            }
            
            try {
                log(`Tentando login com email: ${email}...`);
                const { data, error } = await supabase.auth.signInWithPassword({
                    email,
                    password
                });
                
                if (error) {
                    log(`Erro de login: ${error.message}`, 'error');
                    return;
                }
                
                log('Login realizado com sucesso', 'success');
                checkAuth();
            } catch (err) {
                log(`Erro: ${err.message}`, 'error');
            }
        });
        
        // Verificar registros órfãos
        document.getElementById('checkOrphans').addEventListener('click', checkOrphanedRecords);
        
        async function checkOrphanedRecords() {
            log('Verificando registros órfãos nas tabelas...', 'info');
            const user = await checkAuth();
            
            if (!user) {
                log('Você precisa estar autenticado para verificar registros órfãos', 'error');
                return;
            }
            
            try {
                // 1. Obter todas as disciplinas
                log('1. Obtendo todas as disciplinas...', 'info');
                const { data: disciplinas, error: disciplinasError } = await supabase
                    .from('disciplinas')
                    .select('id');
                
                if (disciplinasError) {
                    log(`Erro ao obter disciplinas: ${disciplinasError.message}`, 'error');
                    return;
                }
                
                const disciplinaIds = disciplinas.map(d => d.id);
                log(`Encontradas ${disciplinaIds.length} disciplinas`, 'info');
                
                // 2. Verificar horários órfãos
                log('2. Verificando horários sem disciplina associada...', 'info');
                const { data: horarios, error: horariosError } = await supabase
                    .from('horarios')
                    .select('*');
                
                if (horariosError) {
                    log(`Erro ao obter horários: ${horariosError.message}`, 'error');
                    return;
                }
                
                // Encontrar registros de horários para disciplinas que não existem mais
                const orphanedSchedules = horarios.filter(h => !disciplinaIds.includes(h.disciplina_id));
                
                if (orphanedSchedules.length > 0) {
                    log(`Encontrados ${orphanedSchedules.length} registros de horários órfãos`, 'warning');
                    orphanedSchedules.forEach(h => {
                        log(`Horário órfão: ID=${h.id}, Disciplina ID=${h.disciplina_id}`, 'warning');
                    });
                    
                    // Perguntar se deseja limpar
                    if (confirm(`Foram encontrados ${orphanedSchedules.length} registros de horários órfãos. Deseja removê-los?`)) {
                        for (const h of orphanedSchedules) {
                            const { error: deleteError } = await supabase
                                .from('horarios')
                                .delete()
                                .eq('id', h.id);
                            
                            if (deleteError) {
                                log(`Erro ao remover horário órfão ${h.id}: ${deleteError.message}`, 'error');
                            } else {
                                log(`Horário órfão ${h.id} removido com sucesso`, 'success');
                            }
                        }
                    }
                } else {
                    log('✓ Nenhum horário órfão encontrado', 'success');
                }
                
                // 3. Verificar prerequisitos órfãos
                log('3. Verificando pré-requisitos sem disciplina associada...', 'info');
                const { data: prereqs, error: prereqsError } = await supabase
                    .from('prerequisitos')
                    .select('*');
                
                if (prereqsError) {
                    log(`Erro ao obter pré-requisitos: ${prereqsError.message}`, 'error');
                    return;
                }
                
                // Encontrar registros de pré-requisitos para disciplinas que não existem mais
                const orphanedPrereqs = prereqs.filter(p => 
                    !disciplinaIds.includes(p.from_disciplina) || 
                    !disciplinaIds.includes(p.to_disciplina)
                );
                
                if (orphanedPrereqs.length > 0) {
                    log(`Encontrados ${orphanedPrereqs.length} registros de pré-requisitos órfãos`, 'warning');
                    orphanedPrereqs.forEach(p => {
                        log(`Pré-requisito órfão: ID=${p.id}, De=${p.from_disciplina}, Para=${p.to_disciplina}`, 'warning');
                    });
                    
                    // Perguntar se deseja limpar
                    if (confirm(`Foram encontrados ${orphanedPrereqs.length} registros de pré-requisitos órfãos. Deseja removê-los?`)) {
                        for (const p of orphanedPrereqs) {
                            const { error: deleteError } = await supabase
                                .from('prerequisitos')
                                .delete()
                                .eq('id', p.id);
                            
                            if (deleteError) {
                                log(`Erro ao remover pré-requisito órfão ${p.id}: ${deleteError.message}`, 'error');
                            } else {
                                log(`Pré-requisito órfão ${p.id} removido com sucesso`, 'success');
                            }
                        }
                    }
                } else {
                    log('✓ Nenhum pré-requisito órfão encontrado', 'success');
                }
                
                log('Verificação de registros órfãos concluída', 'success');
            } catch (err) {
                log(`Erro ao verificar registros órfãos: ${err.message}`, 'error');
            }
        }
        
        // Carregar disciplinas
        document.getElementById('loadDisciplines').addEventListener('click', loadDisciplines);
        
        async function loadDisciplines() {
            disciplineListDiv.innerHTML = '<p>Carregando disciplinas...</p>';
            log('Carregando disciplinas...');
            
            try {
                const { data, error } = await supabase
                    .from('disciplinas')
                    .select('*')
                    .order('period', { ascending: true })
                    .order('row', { ascending: true });
                
                if (error) {
                    disciplineListDiv.innerHTML = `<p class="error">Erro ao carregar disciplinas: ${error.message}</p>`;
                    log(`Erro ao carregar disciplinas: ${error.message}`, 'error');
                    return;
                }
                
                if (!data || data.length === 0) {
                    disciplineListDiv.innerHTML = '<p>Nenhuma disciplina encontrada.</p>';
                    log('Nenhuma disciplina encontrada', 'warning');
                    return;
                }
                
                log(`${data.length} disciplinas carregadas com sucesso`, 'success');
                
                // Renderizar cards de disciplinas
                disciplineListDiv.innerHTML = '';
                data.forEach(discipline => {
                    const card = document.createElement('div');
                    card.className = 'discipline-card';
                    card.innerHTML = `
                        <h3>${discipline.name}</h3>
                        <p>ID: ${discipline.id}</p>
                        <p>Período: ${discipline.period} | Linha: ${discipline.row}</p>
                        <p>Tipo: ${discipline.type} | Créditos: ${discipline.credits}</p>
                        <p>User ID: ${discipline.user_id || 'N/A'}</p>
                        <div>
                            <button class="delete" data-id="${discipline.id}">Excluir</button>
                            <button class="debug" data-id="${discipline.id}">Depurar Exclusão</button>
                        </div>
                    `;
                    disciplineListDiv.appendChild(card);
                });
                
                // Adicionar event listeners
                document.querySelectorAll('button.delete').forEach(btn => {
                    btn.addEventListener('click', (e) => deleteDiscipline(e.target.dataset.id));
                });
                
                document.querySelectorAll('button.debug').forEach(btn => {
                    btn.addEventListener('click', (e) => debugDiscipline(e.target.dataset.id));
                });
            } catch (err) {
                disciplineListDiv.innerHTML = `<p class="error">Erro: ${err.message}</p>`;
                log(`Erro: ${err.message}`, 'error');
            }
        }
        
        // Excluir disciplina
        async function deleteDiscipline(id) {
            if (!confirm(`Tem certeza que deseja excluir a disciplina ${id}?`)) {
                return;
            }
            
            log(`Tentando excluir disciplina ${id}...`);
            
            try {
                // Verificar autenticação
                const user = await checkAuth();
                if (!user) {
                    log('Você precisa estar autenticado para excluir disciplinas', 'error');
                    return;
                }
                
                // Processo correto de exclusão - em ordem:
                
                // 1. Excluir disciplinas concluídas
                log(`1. Excluindo registros de disciplinas_concluidas para disciplina ${id}...`);
                const { error: completedError } = await supabase
                    .from('disciplinas_concluidas')
                    .delete()
                    .eq('disciplina_id', id)
                    .eq('user_id', user.id);
                
                if (completedError) {
                    log(`Erro ao excluir disciplinas concluídas: ${completedError.message}`, 'error');
                    return;
                }
                log('✓ Registros de disciplinas_concluidas excluídos com sucesso', 'success');
                
                // 2. Excluir pré-requisitos onde a disciplina é "from"
                log(`2. Excluindo registros de prerequisitos onde from_disciplina = ${id}...`);
                const { error: preReqFromError } = await supabase
                    .from('prerequisitos')
                    .delete()
                    .eq('from_disciplina', id);
                
                if (preReqFromError) {
                    log(`Erro ao excluir pré-requisitos (from): ${preReqFromError.message}`, 'error');
                    return;
                }
                log('✓ Registros de prerequisitos (from) excluídos com sucesso', 'success');
                
                // 3. Excluir pré-requisitos onde a disciplina é "to"
                log(`3. Excluindo registros de prerequisitos onde to_disciplina = ${id}...`);
                const { error: preReqToError } = await supabase
                    .from('prerequisitos')
                    .delete()
                    .eq('to_disciplina', id);
                
                if (preReqToError) {
                    log(`Erro ao excluir pré-requisitos (to): ${preReqToError.message}`, 'error');
                    return;
                }
                log('✓ Registros de prerequisitos (to) excluídos com sucesso', 'success');
                
                // 4. Excluir horários
                log(`4. Excluindo registros de horarios para disciplina ${id}...`);
                const { error: horariosError } = await supabase
                    .from('horarios')
                    .delete()
                    .eq('disciplina_id', id);
                
                if (horariosError) {
                    log(`Erro ao excluir horários: ${horariosError.message}`, 'error');
                    return;
                }
                log('✓ Registros de horarios excluídos com sucesso', 'success');
                
                // 5. Finalmente, excluir a disciplina
                log(`5. Excluindo disciplina ${id}...`);
                const { error: disciplineError } = await supabase
                    .from('disciplinas')
                    .delete()
                    .eq('id', id)
                    .eq('user_id', user.id);
                
                if (disciplineError) {
                    log(`Erro ao excluir disciplina: ${disciplineError.message}`, 'error');
                    return;
                }
                
                log(`Disciplina ${id} excluída com sucesso!`, 'success');
                
                // Recarregar lista
                loadDisciplines();
            } catch (err) {
                log(`Erro ao excluir disciplina: ${err.message}`, 'error');
            }
        }
        
        // Depurar disciplina (verificar dependências)
        async function debugDiscipline(id) {
            log(`Iniciando depuração para disciplina ${id}...`);
            
            try {
                // Verificar disciplinas_concluidas
                log(`Verificando registros em disciplinas_concluidas para ${id}...`);
                const { data: completedData, error: completedError } = await supabase
                    .from('disciplinas_concluidas')
                    .select('id, user_id')
                    .eq('disciplina_id', id);
                
                if (completedError) {
                    log(`Erro ao verificar disciplinas_concluidas: ${completedError.message}`, 'error');
                } else if (completedData && completedData.length > 0) {
                    log(`Encontrados ${completedData.length} registros em disciplinas_concluidas`, 'info');
                    completedData.forEach(item => {
                        log(`- ID: ${item.id}, User ID: ${item.user_id}`, 'info');
                    });
                } else {
                    log('✓ Nenhum registro em disciplinas_concluidas', 'success');
                }
                
                // Verificar prerequisitos (from)
                log(`Verificando registros em prerequisitos onde from_disciplina = ${id}...`);
                const { data: preReqFromData, error: preReqFromError } = await supabase
                    .from('prerequisitos')
                    .select('id, to_disciplina')
                    .eq('from_disciplina', id);
                
                if (preReqFromError) {
                    log(`Erro ao verificar prerequisitos (from): ${preReqFromError.message}`, 'error');
                } else if (preReqFromData && preReqFromData.length > 0) {
                    log(`Encontrados ${preReqFromData.length} registros em prerequisitos (from)`, 'info');
                    preReqFromData.forEach(item => {
                        log(`- ID: ${item.id}, To: ${item.to_disciplina}`, 'info');
                    });
                } else {
                    log('✓ Nenhum registro em prerequisitos (from)', 'success');
                }
                
                // Verificar prerequisitos (to)
                log(`Verificando registros em prerequisitos onde to_disciplina = ${id}...`);
                const { data: preReqToData, error: preReqToError } = await supabase
                    .from('prerequisitos')
                    .select('id, from_disciplina')
                    .eq('to_disciplina', id);
                
                if (preReqToError) {
                    log(`Erro ao verificar prerequisitos (to): ${preReqToError.message}`, 'error');
                } else if (preReqToData && preReqToData.length > 0) {
                    log(`Encontrados ${preReqToData.length} registros em prerequisitos (to)`, 'info');
                    preReqToData.forEach(item => {
                        log(`- ID: ${item.id}, From: ${item.from_disciplina}`, 'info');
                    });
                } else {
                    log('✓ Nenhum registro em prerequisitos (to)', 'success');
                }
                
                // Verificar horários
                log(`Verificando registros em horarios para disciplina ${id}...`);
                const { data: horariosData, error: horariosError } = await supabase
                    .from('horarios')
                    .select('*')
                    .eq('disciplina_id', id);
                
                if (horariosError) {
                    log(`Erro ao verificar horarios: ${horariosError.message}`, 'error');
                } else if (horariosData && horariosData.length > 0) {
                    log(`Encontrados ${horariosData.length} registros em horarios`, 'info');
                    horariosData.forEach(item => {
                        log(`- ID: ${item.id}, Nome: ${item.nome}, Aulas: ${item.num_aulas}`, 'info');
                        if (item.day1 && item.time1) log(`  - Dia/Hora 1: ${item.day1}/${item.time1}`, 'info');
                        if (item.day2 && item.time2) log(`  - Dia/Hora 2: ${item.day2}/${item.time2}`, 'info');
                        if (item.day3 && item.time3) log(`  - Dia/Hora 3: ${item.day3}/${item.time3}`, 'info');
                    });
                } else {
                    log('✓ Nenhum registro em horarios', 'success');
                }
                
                log('Depuração concluída', 'success');
            } catch (err) {
                log(`Erro durante a depuração: ${err.message}`, 'error');
            }
        }
        
        // Inicializar
        checkAuth();
    </script>
</body>
</html> 